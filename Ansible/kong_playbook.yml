- name: Deploy Docker Compose Applicatio
  hosts: pdp
  become: true

  vars:
    github_docker_compose_url: "https://raw.githubusercontent.com/Haggag-22/zero_guard/main/Docker/Kong_API_Gateway/docker-compose.yml"
    github_kong_config_url: "https://raw.githubusercontent.com/Haggag-22/zero_guard/main/Docker/Kong_API_Gateway/kong.yml"
    docker_compose_path: "/home/pdp/docker-compose.yml"  
    kong_config_path: "/home/pdp/kong.yml"  

  tasks:
    - name: Install Docker
      apt:
        name: docker.io
        state: present
      
    - name: Install Docker Compose
      shell: |
        curl -L "https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
        chmod +x /usr/local/bin/docker-compose
      become: true
      args:
        creates: /usr/local/bin/docker-compose



    - name: Download Docker Compose file from GitHub to the target machine
      get_url:
        url: "{{ github_docker_compose_url }}"
        dest: "{{ docker_compose_path }}"
        mode: '0644'

    - name: Download configuration file from GitHub to the target machine
      get_url:
        url: "{{ github_kong_config_url }}"
        dest: "{{ kong_config_path }}"
        mode: '0644'

    - name: Run Docker Compose to deploy Kong API Gateway on the target machine
      command:
        cmd: docker-compose up -d  # Run docker-compose on the target machine
        chdir: "{{ docker_compose_path | dirname }}"